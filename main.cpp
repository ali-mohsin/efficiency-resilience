#include "starter.h"

int main (int argc, char *argv[])
{

	int failures=1;

	int oneToOne=0;

	int sharing=0;

	dc= new Controller(30,1024,1024,1024,oneToOne,sharing,30000000,0,1);
int runFor=30000000;
dc->instantiateTenant(97,20);
dc->instantiateTenant(15,28);
dc->instantiateTenant(50,257);
dc->instantiateTenant(2,68);
dc->instantiateTenant(19,498);
dc->instantiateTenant(95,346);
dc->instantiateTenant(3,98);
dc->instantiateTenant(5,53);
dc->instantiateTenant(18,261);
dc->instantiateTenant(12,70);
dc->instantiateTenant(12,127);
dc->instantiateTenant(2,192);
dc->instantiateTenant(7,68);
dc->instantiateTenant(125,13);
dc->instantiateTenant(43,32);
dc->instantiateTenant(20,70);
dc->instantiateTenant(167,92);
dc->instantiateTenant(18,36);
dc->instantiateTenant(79,90);
dc->instantiateTenant(92,173);
dc->instantiateTenant(15,25);
dc->instantiateTenant(91,39);
dc->instantiateTenant(105,56);
dc->instantiateTenant(26,64);
dc->instantiateTenant(74,137);
dc->instantiateTenant(23,15);
dc->instantiateTenant(65,87);
dc->instantiateTenant(136,176);
dc->instantiateTenant(17,23);
dc->instantiateTenant(222,35);
dc->instantiateTenant(15,125);
dc->instantiateTenant(30,140);
dc->instantiateTenant(17,71);
dc->instantiateTenant(97,29);
dc->instantiateTenant(108,112);
dc->instantiateTenant(12,1);
dc->instantiateTenant(68,55);
dc->instantiateTenant(45,5);
dc->instantiateTenant(184,82);
dc->instantiateTenant(42,76);
dc->instantiateTenant(18,67);
dc->instantiateTenant(10,242);
dc->instantiateTenant(20,1);
dc->instantiateTenant(31,38);
dc->instantiateTenant(25,116);
dc->instantiateTenant(36,92);
dc->instantiateTenant(159,518);
dc->instantiateTenant(10,106);
dc->instantiateTenant(53,44);
dc->instantiateTenant(30,163);
dc->instantiateTenant(60,42);
dc->instantiateTenant(66,151);
dc->instantiateTenant(2,126);
dc->instantiateTenant(83,12);
dc->instantiateTenant(5,62);
dc->instantiateTenant(9,41);
dc->instantiateTenant(197,25);
dc->instantiateTenant(37,2);
dc->instantiateTenant(46,59);
dc->instantiateTenant(57,48);
dc->instantiateTenant(2,441);
dc->instantiateTenant(139,75);
dc->instantiateTenant(52,169);
dc->instantiateTenant(20,59);
dc->instantiateTenant(20,100);
dc->instantiateTenant(47,110);
dc->instantiateTenant(135,211);
dc->instantiateTenant(36,19);
dc->instantiateTenant(46,68);
dc->instantiateTenant(33,221);
dc->instantiateTenant(8,186);
dc->instantiateTenant(13,8);
dc->instantiateTenant(60,52);
dc->instantiateTenant(36,231);
dc->instantiateTenant(18,111);
dc->instantiateTenant(7,71);
dc->instantiateTenant(49,223);
dc->instantiateTenant(2,70);
dc->instantiateTenant(63,66);
dc->instantiateTenant(42,24);
dc->instantiateTenant(35,2);
dc->instantiateTenant(59,27);
dc->instantiateTenant(130,34);
dc->instantiateTenant(2,147);
dc->instantiateTenant(46,13);
dc->instantiateTenant(9,32);
dc->instantiateTenant(48,80);
dc->instantiateTenant(113,260);
dc->instantiateTenant(96,110);
dc->instantiateTenant(44,264);
dc->instantiateTenant(16,54);
dc->instantiateTenant(3,21);
dc->instantiateTenant(17,95);
dc->instantiateTenant(58,69);
dc->instantiateTenant(44,17);
dc->instantiateTenant(150,188);
dc->instantiateTenant(76,55);
dc->instantiateTenant(10,162);
dc->instantiateTenant(15,29);
dc->instantiateTenant(31,52);
dc->instantiateTenant(6,18);
dc->instantiateTenant(85,213);
dc->instantiateTenant(2,142);
dc->instantiateTenant(3,12);
dc->instantiateTenant(196,9);
dc->instantiateTenant(56,183);
dc->instantiateTenant(28,40);
dc->instantiateTenant(18,65);
dc->instantiateTenant(33,44);
dc->instantiateTenant(2,123);
dc->instantiateTenant(16,26);
dc->instantiateTenant(69,14);
dc->instantiateTenant(40,421);
dc->instantiateTenant(18,49);
dc->instantiateTenant(46,95);
dc->instantiateTenant(7,488);
dc->instantiateTenant(125,36);
dc->instantiateTenant(2,73);
dc->instantiateTenant(79,91);
dc->instantiateTenant(32,26);
dc->instantiateTenant(28,91);
dc->instantiateTenant(42,235);
dc->instantiateTenant(34,8);
dc->instantiateTenant(70,37);
dc->instantiateTenant(9,43);
dc->instantiateTenant(40,27);
dc->instantiateTenant(56,12);
dc->instantiateTenant(5,11);
dc->instantiateTenant(53,28);
dc->instantiateTenant(49,68);
dc->instantiateTenant(18,589);
dc->instantiateTenant(76,156);
dc->instantiateTenant(16,6);
dc->instantiateTenant(3,173);
dc->instantiateTenant(27,62);
dc->instantiateTenant(23,57);
dc->instantiateTenant(19,23);
dc->instantiateTenant(86,27);
dc->instantiateTenant(72,16);
dc->instantiateTenant(15,23);
dc->instantiateTenant(46,30);
dc->instantiateTenant(97,525);
dc->instantiateTenant(24,205);
dc->instantiateTenant(2,14);
dc->instantiateTenant(11,305);
dc->instantiateTenant(46,225);
dc->instantiateTenant(11,116);
dc->instantiateTenant(100,80);
dc->instantiateTenant(38,128);
dc->instantiateTenant(15,10);
dc->instantiateTenant(7,163);
dc->instantiateTenant(76,23);
dc->instantiateTenant(82,41);
dc->instantiateTenant(34,113);
dc->instantiateTenant(34,1);
dc->instantiateTenant(2,111);
dc->instantiateTenant(145,12);
dc->instantiateTenant(19,332);
dc->instantiateTenant(16,7);
dc->instantiateTenant(2,38);
dc->instantiateTenant(40,300);
dc->instantiateTenant(18,57);
dc->instantiateTenant(18,33);
dc->instantiateTenant(5,283);
dc->instantiateTenant(22,82);
dc->instantiateTenant(23,49);
dc->instantiateTenant(12,30);
dc->instantiateTenant(29,160);
dc->instantiateTenant(17,255);
dc->instantiateTenant(4,1);
dc->instantiateTenant(96,46);
dc->instantiateTenant(22,84);
dc->instantiateTenant(40,40);
dc->instantiateTenant(21,121);
dc->instantiateTenant(81,101);
dc->instantiateTenant(75,124);
dc->instantiateTenant(62,347);
dc->instantiateTenant(52,53);
dc->instantiateTenant(23,151);
dc->instantiateTenant(2,16);
dc->instantiateTenant(114,2);
dc->instantiateTenant(35,319);
dc->instantiateTenant(4,134);
dc->instantiateTenant(8,29);
dc->instantiateTenant(8,67);
dc->instantiateTenant(77,87);
dc->instantiateTenant(96,84);
dc->instantiateTenant(17,13);
dc->instantiateTenant(45,44);
dc->instantiateTenant(47,47);
dc->instantiateTenant(5,213);
dc->instantiateTenant(44,23);
dc->instantiateTenant(22,33);
dc->instantiateTenant(26,46);
dc->instantiateTenant(14,142);
dc->instantiateTenant(11,4);
dc->instantiateTenant(128,134);
dc->instantiateTenant(327,151);
dc->instantiateTenant(31,88);
dc->instantiateTenant(124,159);
dc->instantiateTenant(3,35);
dc->instantiateTenant(2,1);
dc->instantiateTenant(13,177);
dc->instantiateTenant(40,39);
dc->instantiateTenant(84,276);
dc->instantiateTenant(44,128);
dc->instantiateTenant(58,219);
dc->instantiateTenant(10,114);
dc->instantiateTenant(20,35);
dc->instantiateTenant(25,167);
dc->instantiateTenant(135,332);
dc->instantiateTenant(160,104);
dc->instantiateTenant(14,22);
dc->instantiateTenant(28,167);
dc->instantiateTenant(31,59);
dc->instantiateTenant(10,28);
dc->instantiateTenant(45,23);
dc->instantiateTenant(42,57);
dc->instantiateTenant(120,239);
dc->instantiateTenant(5,63);
dc->instantiateTenant(35,30);
dc->instantiateTenant(46,113);
dc->instantiateTenant(12,92);
dc->instantiateTenant(17,65);
dc->instantiateTenant(4,348);
dc->instantiateTenant(28,24);
dc->instantiateTenant(33,66);
dc->instantiateTenant(50,31);
dc->instantiateTenant(14,7);
dc->instantiateTenant(37,42);
dc->instantiateTenant(12,9);
dc->instantiateTenant(3,36);
dc->instantiateTenant(3,168);
dc->instantiateTenant(103,197);
dc->instantiateTenant(14,16);
dc->instantiateTenant(18,3);
dc->instantiateTenant(19,121);
dc->instantiateTenant(33,23);
dc->instantiateTenant(162,38);
dc->instantiateTenant(2,68);
dc->instantiateTenant(7,190);
dc->instantiateTenant(40,29);
dc->instantiateTenant(2,31);
dc->instantiateTenant(59,81);
dc->instantiateTenant(12,72);
dc->instantiateTenant(23,383);
dc->instantiateTenant(11,306);
dc->instantiateTenant(7,293);
dc->instantiateTenant(12,11);
dc->instantiateTenant(54,92);
dc->instantiateTenant(8,66);
dc->instantiateTenant(14,66);
dc->instantiateTenant(74,69);
dc->instantiateTenant(25,118);
dc->instantiateTenant(13,61);
dc->instantiateTenant(84,24);
dc->instantiateTenant(5,275);
dc->instantiateTenant(90,7);
dc->instantiateTenant(5,135);
dc->instantiateTenant(43,196);
dc->instantiateTenant(7,14);
dc->instantiateTenant(28,147);
dc->instantiateTenant(22,96);
dc->instantiateTenant(60,1);
dc->instantiateTenant(31,3);
dc->instantiateTenant(2,199);
dc->instantiateTenant(68,22);
dc->instantiateTenant(37,80);
dc->instantiateTenant(21,45);
dc->instantiateTenant(2,15);
dc->instantiateTenant(40,229);
dc->instantiateTenant(27,16);
dc->instantiateTenant(40,47);
dc->instantiateTenant(49,351);
dc->instantiateTenant(30,20);
dc->instantiateTenant(2,101);
dc->instantiateTenant(23,51);
dc->instantiateTenant(27,228);
dc->instantiateTenant(29,116);
dc->instantiateTenant(16,98);
dc->instantiateTenant(13,108);
dc->instantiateTenant(102,18);
dc->instantiateTenant(204,39);
dc->instantiateTenant(78,122);
dc->instantiateTenant(94,41);
dc->instantiateTenant(2,47);
dc->instantiateTenant(112,232);
dc->instantiateTenant(53,39);
dc->instantiateTenant(34,159);
dc->instantiateTenant(111,86);
dc->instantiateTenant(18,6);
dc->instantiateTenant(20,6);
dc->instantiateTenant(10,28);
dc->instantiateTenant(55,61);
dc->instantiateTenant(117,161);
dc->instantiateTenant(31,7);
dc->instantiateTenant(123,44);
dc->instantiateTenant(18,58);
dc->instantiateTenant(44,307);
dc->instantiateTenant(83,72);
dc->instantiateTenant(115,152);
dc->instantiateTenant(87,18);
dc->instantiateTenant(86,80);
dc->instantiateTenant(16,169);
dc->instantiateTenant(157,81);
dc->instantiateTenant(14,52);
dc->instantiateTenant(15,121);
dc->instantiateTenant(31,49);
dc->instantiateTenant(114,64);
dc->instantiateTenant(17,40);
dc->instantiateTenant(3,9);
dc->instantiateTenant(35,27);
dc->instantiateTenant(20,153);
dc->instantiateTenant(39,15);
dc->instantiateTenant(51,151);
dc->instantiateTenant(7,22);
dc->instantiateTenant(10,184);
dc->instantiateTenant(28,83);
dc->instantiateTenant(124,365);
dc->instantiateTenant(25,3);
dc->instantiateTenant(84,23);
dc->instantiateTenant(72,170);
dc->instantiateTenant(55,8);
dc->instantiateTenant(16,293);
dc->instantiateTenant(33,15);
dc->instantiateTenant(46,229);
dc->instantiateTenant(4,79);
dc->instantiateTenant(60,42);
dc->instantiateTenant(64,33);
dc->instantiateTenant(70,210);
dc->instantiateTenant(9,51);
dc->instantiateTenant(15,61);
dc->instantiateTenant(96,348);
dc->instantiateTenant(19,66);
dc->instantiateTenant(57,254);
dc->instantiateTenant(50,62);
dc->instantiateTenant(104,85);
dc->instantiateTenant(8,123);
dc->instantiateTenant(2,149);
dc->instantiateTenant(6,157);
dc->instantiateTenant(42,32);
dc->instantiateTenant(51,75);
dc->instantiateTenant(10,331);
dc->instantiateTenant(70,29);
dc->instantiateTenant(2,11);
dc->instantiateTenant(9,1);
dc->instantiateTenant(20,66);
dc->instantiateTenant(31,89);
dc->instantiateTenant(16,151);
dc->instantiateTenant(73,85);
dc->instantiateTenant(69,37);
dc->instantiateTenant(59,217);
dc->instantiateTenant(43,126);
dc->instantiateTenant(83,221);
dc->instantiateTenant(10,145);
dc->instantiateTenant(69,152);
dc->instantiateTenant(92,193);
dc->instantiateTenant(13,110);
dc->instantiateTenant(2,21);
dc->instantiateTenant(15,72);
dc->instantiateTenant(31,14);
dc->instantiateTenant(21,116);
dc->instantiateTenant(53,250);
dc->instantiateTenant(6,66);
dc->instantiateTenant(32,82);
dc->instantiateTenant(9,11);
dc->instantiateTenant(32,90);
dc->instantiateTenant(139,99);
dc->instantiateTenant(14,69);
dc->instantiateTenant(28,116);
dc->instantiateTenant(49,189);
dc->instantiateTenant(62,82);
dc->instantiateTenant(92,145);
dc->instantiateTenant(173,84);
dc->instantiateTenant(7,240);
dc->instantiateTenant(8,156);
dc->instantiateTenant(156,89);
dc->instantiateTenant(45,32);
dc->instantiateTenant(56,37);
dc->instantiateTenant(2,40);
dc->instantiateTenant(3,212);
dc->instantiateTenant(8,8);
dc->instantiateTenant(99,22);
dc->instantiateTenant(19,147);
dc->instantiateTenant(26,57);
dc->instantiateTenant(13,48);
dc->instantiateTenant(23,214);
dc->instantiateTenant(144,58);
dc->instantiateTenant(84,101);
dc->instantiateTenant(44,301);
dc->instantiateTenant(46,5);
dc->instantiateTenant(52,126);
dc->instantiateTenant(14,277);
dc->instantiateTenant(3,23);
dc->instantiateTenant(45,3);
dc->instantiateTenant(6,53);
dc->instantiateTenant(92,22);
dc->instantiateTenant(45,56);
dc->instantiateTenant(83,38);
dc->instantiateTenant(45,17);
dc->instantiateTenant(88,1);
dc->instantiateTenant(23,115);
dc->instantiateTenant(11,59);
dc->instantiateTenant(12,119);
dc->instantiateTenant(29,101);
dc->instantiateTenant(92,9);
dc->instantiateTenant(30,129);
dc->instantiateTenant(19,192);
dc->instantiateTenant(25,85);
dc->instantiateTenant(11,216);
dc->instantiateTenant(18,3);
dc->instantiateTenant(23,12);
dc->instantiateTenant(2,306);
dc->instantiateTenant(66,35);
dc->instantiateTenant(75,132);
dc->instantiateTenant(186,11);
dc->instantiateTenant(10,131);
dc->instantiateTenant(33,10);
dc->instantiateTenant(28,30);
dc->instantiateTenant(70,63);
dc->instantiateTenant(2,135);
dc->instantiateTenant(10,168);
dc->instantiateTenant(47,7);
dc->instantiateTenant(4,1);
dc->instantiateTenant(165,35);
dc->instantiateTenant(60,30);
dc->instantiateTenant(34,94);
dc->instantiateTenant(48,19);
dc->instantiateTenant(97,221);
dc->instantiateTenant(50,27);
dc->instantiateTenant(55,51);
dc->instantiateTenant(12,2);
dc->instantiateTenant(69,119);
dc->instantiateTenant(34,67);
dc->instantiateTenant(17,46);
dc->instantiateTenant(114,111);
dc->instantiateTenant(2,242);
dc->instantiateTenant(52,43);
dc->instantiateTenant(24,154);
dc->instantiateTenant(11,68);
dc->instantiateTenant(100,14);
dc->instantiateTenant(48,312);
dc->instantiateTenant(2,35);
dc->instantiateTenant(72,52);
dc->instantiateTenant(99,117);
dc->instantiateTenant(80,184);
dc->instantiateTenant(171,239);
dc->instantiateTenant(78,54);
dc->instantiateTenant(13,95);
dc->instantiateTenant(121,103);
dc->instantiateTenant(16,64);
dc->instantiateTenant(41,262);
dc->instantiateTenant(60,79);
dc->instantiateTenant(45,13);
dc->instantiateTenant(9,367);
dc->instantiateTenant(9,63);
dc->instantiateTenant(64,67);
dc->instantiateTenant(29,271);
dc->instantiateTenant(75,79);
dc->instantiateTenant(33,118);
dc->instantiateTenant(68,1);
dc->instantiateTenant(23,8);
dc->instantiateTenant(34,51);
dc->instantiateTenant(8,3);
dc->instantiateTenant(129,1);
dc->instantiateTenant(85,100);
dc->instantiateTenant(71,155);
dc->instantiateTenant(203,54);
dc->instantiateTenant(61,37);
dc->instantiateTenant(20,102);
dc->instantiateTenant(24,32);
dc->instantiateTenant(15,1056);
dc->instantiateTenant(37,27);
dc->instantiateTenant(2,314);
dc->instantiateTenant(60,55);
dc->instantiateTenant(23,44);
dc->instantiateTenant(45,16);
dc->instantiateTenant(97,299);
dc->instantiateTenant(11,77);
dc->instantiateTenant(95,45);
dc->instantiateTenant(169,17);
dc->instantiateTenant(60,104);
dc->instantiateTenant(9,32);
dc->instantiateTenant(179,238);
dc->instantiateTenant(2,50);
dc->instantiateTenant(133,57);
dc->instantiateTenant(40,307);
dc->instantiateTenant(175,108);
dc->instantiateTenant(28,210);
dc->instantiateTenant(4,11);
dc->instantiateTenant(103,14);
dc->instantiateTenant(59,7);
dc->instantiateTenant(14,167);
dc->instantiateTenant(79,113);
dc->instantiateTenant(181,249);
dc->instantiateTenant(19,7);
dc->instantiateTenant(141,10);
dc->instantiateTenant(33,67);
dc->instantiateTenant(90,226);
dc->instantiateTenant(29,1);


	//Main tasks that this code does is that iterate for run number of times and after every ping interval which represents 1 sec, dump the data, 

	pthread_t t1,t2;//, t3;
//	pthread_create(&t1, NULL, pingFaults, NULL);

	int flowsNum = dc->all_flows.size();
	end_delay = 1000000 + 5.0;
	struct timespec time1, time2;
	time1.tv_sec = 0;
	time1.tv_nsec = 10; // interval of 100 nano sec, 

	//TODO (ali-mohsin), verify this 100 nsec is the optimal, if not then it can be optimized

	int runs = (runFor);
	int num_fails = failTimes.size(); // would compute to 0

	// cout<<"Number of run: "<<runs<<"\n";
	if(failures)
	{
		for(int i=0; i<runs; i++)
		{
			if (i%100000==0)
				cout<<i<<"th run"<<endl;
			

			dc->autofail(i);
			// seconds_run++;
			// if( (seconds_run % inter_ping_time) == 0 )
			// {
			// 	if( (seconds_run % 31536000) == 0 )
			// 	{
			// 		years_run++;
			// 		seconds_run = seconds_run - 31536000;
			// 	}
			// 	long time_so_far = years_run*31536000 + seconds_run;
			// }

			// if(nanosleep(&time1, &time2) < 0)
			// {
			// 	cout<<"Nanosleep() failed\n";
			// 	return -1;
			// }

			// for(int j=0; j<flowsNum; j++)
			// {
			// 	if( ((dc->all_flows[j]->getActive() + dc->all_flows[j]->getStart()) < run_time ) && (!(dc->all_flows[j]->getDone())))
			// 	{
			// 		dc->all_flows[j]->setDone(true);
			// 		cout<<"Flow has completed!\n";
			// 	}
			// }
		}
	}
	else
	{

		cout<<"You are running simulation with out failures, You are not in Sproj 1 anymore! Please add -failure flag "<<endl;
	}

	finishThis = true;


	int downTime=0;
	int one=0;
	int two=0;
	int three=0;
	int vms;
	for(int i=0;i<dc->all_tenants.size();i++)
	{
		if(dc->all_tenants[i]->level==1)
			one+=dc->all_tenants[i]->downTime;
		if(dc->all_tenants[i]->level==2)
			two+=dc->all_tenants[i]->downTime;
		if(dc->all_tenants[i]->level==3)
			three+=dc->all_tenants[i]->downTime;
		downTime+=dc->all_tenants[i]->downTime;
	}

	cout<<dc->all_tenants.size()<<" was the number of accomodated tenants"<<endl;
	cout<<100-100*(downTime/(float(dc->all_tenants.size())*runs))<<" Was the Availability"<<endl;
	cout<<"Downtime due to level 1: "<<one<<endl;
	cout<<"Downtime due to level 2: "<<two<<endl;
	cout<<"Downtime due to level 3: "<<three<<endl;
		// cout<<100-100*(dc->downTime/(float(dc->all_flows.size())*runs))<<" Was the Availability"<<endl;


	// ********************************** USEFUL CODE ENDS HERE *********************

	return 0;
}

void storeFailure(int pid, int level, int did, float fTime)
{
	failTimes.push_back(fTime);
	failPID.push_back(pid);
	failLevel.push_back(level);
	failDID.push_back(did);
	failed.push_back(false);
	failComplete.push_back(0.0);
}

void * pingFaults(void * args)
{
	struct timespec time1, time2;
	time1.tv_sec = 0;
	time1.tv_nsec = 1000000;	//this is 1 usec == 0.001 msec == 0.000001 sec
	int fault_runs = (fault_delay*1000000000)/time1.tv_nsec;	//calculating num runs to achieve the delay

	while(1)
	{
		// cout<<"here"<<endl;
		for(int i=0; i<fault_runs; i++)
		{
			if(nanosleep(&time1, &time2) < 0)
			{
				cout<<"Nanosleep() failed\n";
				exit(-1);
			}
			if(finishThis)
			{
				pthread_exit(NULL);
			}
		}
		//call the detect fault function

		// while(busy)
		// {
		// 	if(nanosleep(&time1, &time2) < 0)
		// 	{
		// 		cout<<"Nanosleep() failed\n";
		// 		exit(-1);
		// 	}
		// }
		// busy = true;
		run_faults = run_time;
//		cout<<"About to find faults!\n";
		dc->findFaults();
//		cout<<"Done finding faults!\n";
		// busy = false;

		if(finishThis)
		{
			pthread_exit(NULL);
		}
	}

}
