#include "starter.h"

int main (int argc, char *argv[])
{

	int failures=1;

	int oneToOne=0;

	int sharing=0;

	dc= new Controller(30,1024,1024,1024,oneToOne,sharing,30000000,0,1);
int runFor=30000000;
dc->instantiateTenant(7,33);
dc->instantiateTenant(14,66);
dc->instantiateTenant(69,71);
dc->instantiateTenant(2,198);
dc->instantiateTenant(22,15);
dc->instantiateTenant(20,42);
dc->instantiateTenant(15,102);
dc->instantiateTenant(63,31);
dc->instantiateTenant(114,77);
dc->instantiateTenant(39,64);
dc->instantiateTenant(70,10);
dc->instantiateTenant(160,142);
dc->instantiateTenant(5,94);
dc->instantiateTenant(15,38);
dc->instantiateTenant(93,184);
dc->instantiateTenant(173,63);
dc->instantiateTenant(15,138);
dc->instantiateTenant(117,4);
dc->instantiateTenant(88,51);
dc->instantiateTenant(6,259);
dc->instantiateTenant(36,188);
dc->instantiateTenant(13,11);
dc->instantiateTenant(7,32);
dc->instantiateTenant(94,49);
dc->instantiateTenant(23,168);
dc->instantiateTenant(24,58);
dc->instantiateTenant(68,165);
dc->instantiateTenant(46,6);
dc->instantiateTenant(20,131);
dc->instantiateTenant(80,75);
dc->instantiateTenant(9,37);
dc->instantiateTenant(11,81);
dc->instantiateTenant(7,19);
dc->instantiateTenant(35,270);
dc->instantiateTenant(20,524);
dc->instantiateTenant(18,123);
dc->instantiateTenant(89,126);
dc->instantiateTenant(74,239);
dc->instantiateTenant(138,49);
dc->instantiateTenant(19,82);
dc->instantiateTenant(69,213);
dc->instantiateTenant(120,204);
dc->instantiateTenant(41,184);
dc->instantiateTenant(16,198);
dc->instantiateTenant(13,75);
dc->instantiateTenant(127,65);
dc->instantiateTenant(2,45);
dc->instantiateTenant(48,265);
dc->instantiateTenant(27,140);
dc->instantiateTenant(31,477);
dc->instantiateTenant(19,64);
dc->instantiateTenant(145,67);
dc->instantiateTenant(93,183);
dc->instantiateTenant(103,22);
dc->instantiateTenant(3,31);
dc->instantiateTenant(5,136);
dc->instantiateTenant(41,4);
dc->instantiateTenant(56,13);
dc->instantiateTenant(39,498);
dc->instantiateTenant(11,15);
dc->instantiateTenant(24,119);
dc->instantiateTenant(3,14);
dc->instantiateTenant(49,34);
dc->instantiateTenant(15,298);
dc->instantiateTenant(2,81);
dc->instantiateTenant(54,37);
dc->instantiateTenant(13,272);
dc->instantiateTenant(12,449);
dc->instantiateTenant(23,225);
dc->instantiateTenant(40,147);
dc->instantiateTenant(71,34);
dc->instantiateTenant(55,69);
dc->instantiateTenant(49,142);
dc->instantiateTenant(153,98);
dc->instantiateTenant(33,165);
dc->instantiateTenant(11,52);
dc->instantiateTenant(34,7);
dc->instantiateTenant(28,87);
dc->instantiateTenant(70,116);
dc->instantiateTenant(113,161);
dc->instantiateTenant(94,131);
dc->instantiateTenant(114,97);
dc->instantiateTenant(101,237);
dc->instantiateTenant(25,37);
dc->instantiateTenant(61,76);
dc->instantiateTenant(32,25);
dc->instantiateTenant(46,75);
dc->instantiateTenant(48,24);
dc->instantiateTenant(133,26);
dc->instantiateTenant(89,5);
dc->instantiateTenant(94,80);
dc->instantiateTenant(11,20);
dc->instantiateTenant(72,1);
dc->instantiateTenant(2,13);
dc->instantiateTenant(8,21);
dc->instantiateTenant(52,48);
dc->instantiateTenant(14,29);
dc->instantiateTenant(3,6);
dc->instantiateTenant(39,1);
dc->instantiateTenant(11,211);
dc->instantiateTenant(65,206);
dc->instantiateTenant(98,143);
dc->instantiateTenant(3,66);
dc->instantiateTenant(10,33);
dc->instantiateTenant(5,67);
dc->instantiateTenant(12,4);
dc->instantiateTenant(24,37);
dc->instantiateTenant(30,116);
dc->instantiateTenant(75,179);
dc->instantiateTenant(2,100);
dc->instantiateTenant(31,7);
dc->instantiateTenant(50,47);
dc->instantiateTenant(37,60);
dc->instantiateTenant(41,272);
dc->instantiateTenant(67,11);
dc->instantiateTenant(135,45);
dc->instantiateTenant(52,14);
dc->instantiateTenant(164,32);
dc->instantiateTenant(8,60);
dc->instantiateTenant(3,25);
dc->instantiateTenant(91,54);
dc->instantiateTenant(36,11);
dc->instantiateTenant(31,130);
dc->instantiateTenant(7,404);
dc->instantiateTenant(58,50);
dc->instantiateTenant(19,155);
dc->instantiateTenant(4,70);
dc->instantiateTenant(41,49);
dc->instantiateTenant(85,48);
dc->instantiateTenant(127,94);
dc->instantiateTenant(23,1);
dc->instantiateTenant(47,14);
dc->instantiateTenant(18,105);
dc->instantiateTenant(82,47);
dc->instantiateTenant(12,46);
dc->instantiateTenant(30,46);
dc->instantiateTenant(15,25);
dc->instantiateTenant(102,23);
dc->instantiateTenant(57,84);
dc->instantiateTenant(35,180);
dc->instantiateTenant(41,8);
dc->instantiateTenant(225,56);
dc->instantiateTenant(23,200);
dc->instantiateTenant(159,5);
dc->instantiateTenant(122,11);
dc->instantiateTenant(2,91);
dc->instantiateTenant(13,14);
dc->instantiateTenant(4,224);
dc->instantiateTenant(14,12);
dc->instantiateTenant(139,46);
dc->instantiateTenant(57,6);
dc->instantiateTenant(18,61);
dc->instantiateTenant(8,22);
dc->instantiateTenant(2,88);
dc->instantiateTenant(39,25);
dc->instantiateTenant(58,145);
dc->instantiateTenant(11,184);
dc->instantiateTenant(231,112);
dc->instantiateTenant(31,4);
dc->instantiateTenant(32,20);
dc->instantiateTenant(19,121);
dc->instantiateTenant(121,53);
dc->instantiateTenant(79,220);
dc->instantiateTenant(45,60);
dc->instantiateTenant(18,4);
dc->instantiateTenant(35,15);
dc->instantiateTenant(15,568);
dc->instantiateTenant(41,70);
dc->instantiateTenant(7,41);
dc->instantiateTenant(36,137);
dc->instantiateTenant(72,3);
dc->instantiateTenant(79,5);
dc->instantiateTenant(11,1);
dc->instantiateTenant(38,22);
dc->instantiateTenant(70,348);
dc->instantiateTenant(6,102);
dc->instantiateTenant(3,22);
dc->instantiateTenant(3,5);
dc->instantiateTenant(82,41);
dc->instantiateTenant(13,5);
dc->instantiateTenant(13,5);
dc->instantiateTenant(70,25);
dc->instantiateTenant(25,82);
dc->instantiateTenant(140,7);
dc->instantiateTenant(11,233);
dc->instantiateTenant(29,11);
dc->instantiateTenant(2,64);
dc->instantiateTenant(143,172);
dc->instantiateTenant(9,7);
dc->instantiateTenant(124,235);
dc->instantiateTenant(106,58);
dc->instantiateTenant(7,11);
dc->instantiateTenant(65,100);
dc->instantiateTenant(46,9);
dc->instantiateTenant(2,390);
dc->instantiateTenant(8,86);
dc->instantiateTenant(11,13);
dc->instantiateTenant(13,26);
dc->instantiateTenant(4,5);
dc->instantiateTenant(146,90);
dc->instantiateTenant(23,3);
dc->instantiateTenant(9,54);
dc->instantiateTenant(15,67);
dc->instantiateTenant(57,244);
dc->instantiateTenant(9,41);
dc->instantiateTenant(2,48);
dc->instantiateTenant(9,130);
dc->instantiateTenant(66,65);
dc->instantiateTenant(74,14);
dc->instantiateTenant(2,124);
dc->instantiateTenant(63,66);
dc->instantiateTenant(57,9);
dc->instantiateTenant(9,13);
dc->instantiateTenant(54,210);
dc->instantiateTenant(8,121);
dc->instantiateTenant(2,2);
dc->instantiateTenant(41,21);
dc->instantiateTenant(50,9);
dc->instantiateTenant(49,25);
dc->instantiateTenant(33,244);
dc->instantiateTenant(6,49);
dc->instantiateTenant(33,74);
dc->instantiateTenant(53,72);
dc->instantiateTenant(41,147);
dc->instantiateTenant(50,82);
dc->instantiateTenant(51,36);
dc->instantiateTenant(33,137);
dc->instantiateTenant(11,55);
dc->instantiateTenant(4,117);
dc->instantiateTenant(78,64);
dc->instantiateTenant(20,57);
dc->instantiateTenant(18,1);
dc->instantiateTenant(5,63);
dc->instantiateTenant(4,15);
dc->instantiateTenant(12,120);
dc->instantiateTenant(14,36);
dc->instantiateTenant(5,117);
dc->instantiateTenant(18,28);
dc->instantiateTenant(24,144);
dc->instantiateTenant(35,8);
dc->instantiateTenant(68,134);
dc->instantiateTenant(88,56);
dc->instantiateTenant(130,193);
dc->instantiateTenant(67,39);
dc->instantiateTenant(19,140);
dc->instantiateTenant(139,38);
dc->instantiateTenant(58,110);
dc->instantiateTenant(12,175);
dc->instantiateTenant(12,134);
dc->instantiateTenant(16,401);
dc->instantiateTenant(122,39);
dc->instantiateTenant(38,150);
dc->instantiateTenant(30,84);
dc->instantiateTenant(30,41);
dc->instantiateTenant(9,115);
dc->instantiateTenant(24,25);
dc->instantiateTenant(99,76);
dc->instantiateTenant(40,167);
dc->instantiateTenant(27,16);
dc->instantiateTenant(2,623);
dc->instantiateTenant(31,29);
dc->instantiateTenant(2,100);
dc->instantiateTenant(37,224);
dc->instantiateTenant(2,4);
dc->instantiateTenant(8,144);
dc->instantiateTenant(56,18);
dc->instantiateTenant(260,144);
dc->instantiateTenant(22,72);
dc->instantiateTenant(33,32);
dc->instantiateTenant(16,336);
dc->instantiateTenant(3,116);
dc->instantiateTenant(44,100);
dc->instantiateTenant(13,64);
dc->instantiateTenant(36,15);
dc->instantiateTenant(73,16);
dc->instantiateTenant(2,67);
dc->instantiateTenant(48,44);
dc->instantiateTenant(9,65);
dc->instantiateTenant(74,50);
dc->instantiateTenant(32,11);
dc->instantiateTenant(81,11);
dc->instantiateTenant(90,69);
dc->instantiateTenant(37,57);
dc->instantiateTenant(23,105);
dc->instantiateTenant(148,66);
dc->instantiateTenant(56,445);
dc->instantiateTenant(50,63);
dc->instantiateTenant(42,44);
dc->instantiateTenant(2,5);
dc->instantiateTenant(21,17);
dc->instantiateTenant(11,235);
dc->instantiateTenant(34,54);
dc->instantiateTenant(2,7);
dc->instantiateTenant(68,102);
dc->instantiateTenant(7,39);
dc->instantiateTenant(62,40);
dc->instantiateTenant(183,205);
dc->instantiateTenant(118,1);
dc->instantiateTenant(4,20);
dc->instantiateTenant(10,129);
dc->instantiateTenant(98,245);
dc->instantiateTenant(44,334);
dc->instantiateTenant(37,11);
dc->instantiateTenant(8,70);
dc->instantiateTenant(3,285);
dc->instantiateTenant(2,157);
dc->instantiateTenant(24,166);
dc->instantiateTenant(28,105);
dc->instantiateTenant(19,4);
dc->instantiateTenant(23,19);
dc->instantiateTenant(52,13);
dc->instantiateTenant(52,35);
dc->instantiateTenant(9,25);
dc->instantiateTenant(35,108);
dc->instantiateTenant(77,27);
dc->instantiateTenant(88,22);
dc->instantiateTenant(44,174);
dc->instantiateTenant(25,24);
dc->instantiateTenant(39,731);
dc->instantiateTenant(75,135);
dc->instantiateTenant(21,113);
dc->instantiateTenant(171,423);
dc->instantiateTenant(181,180);
dc->instantiateTenant(22,62);
dc->instantiateTenant(49,140);
dc->instantiateTenant(28,81);
dc->instantiateTenant(14,20);
dc->instantiateTenant(41,152);
dc->instantiateTenant(127,166);
dc->instantiateTenant(118,91);
dc->instantiateTenant(17,2);
dc->instantiateTenant(16,38);
dc->instantiateTenant(87,45);
dc->instantiateTenant(31,34);
dc->instantiateTenant(3,51);
dc->instantiateTenant(9,49);
dc->instantiateTenant(15,38);
dc->instantiateTenant(5,154);
dc->instantiateTenant(139,158);
dc->instantiateTenant(15,119);
dc->instantiateTenant(71,210);
dc->instantiateTenant(23,124);
dc->instantiateTenant(40,686);
dc->instantiateTenant(20,633);
dc->instantiateTenant(28,49);
dc->instantiateTenant(8,86);
dc->instantiateTenant(64,25);
dc->instantiateTenant(21,67);
dc->instantiateTenant(38,60);
dc->instantiateTenant(98,27);
dc->instantiateTenant(82,98);
dc->instantiateTenant(30,69);
dc->instantiateTenant(72,174);
dc->instantiateTenant(13,73);
dc->instantiateTenant(13,136);
dc->instantiateTenant(132,246);
dc->instantiateTenant(2,16);
dc->instantiateTenant(138,13);
dc->instantiateTenant(22,45);
dc->instantiateTenant(52,116);
dc->instantiateTenant(8,28);
dc->instantiateTenant(6,5);
dc->instantiateTenant(40,55);
dc->instantiateTenant(50,100);
dc->instantiateTenant(3,24);
dc->instantiateTenant(4,46);
dc->instantiateTenant(56,43);
dc->instantiateTenant(86,140);
dc->instantiateTenant(6,13);
dc->instantiateTenant(64,241);
dc->instantiateTenant(115,225);
dc->instantiateTenant(116,1);
dc->instantiateTenant(2,70);
dc->instantiateTenant(38,143);
dc->instantiateTenant(19,79);
dc->instantiateTenant(200,49);
dc->instantiateTenant(151,123);
dc->instantiateTenant(203,3);
dc->instantiateTenant(25,522);
dc->instantiateTenant(96,52);
dc->instantiateTenant(14,17);
dc->instantiateTenant(176,144);
dc->instantiateTenant(31,25);
dc->instantiateTenant(73,73);
dc->instantiateTenant(35,44);
dc->instantiateTenant(81,130);
dc->instantiateTenant(107,54);
dc->instantiateTenant(89,201);
dc->instantiateTenant(120,104);
dc->instantiateTenant(7,8);
dc->instantiateTenant(10,58);
dc->instantiateTenant(31,194);
dc->instantiateTenant(38,12);
dc->instantiateTenant(10,87);
dc->instantiateTenant(146,22);
dc->instantiateTenant(10,172);
dc->instantiateTenant(14,81);
dc->instantiateTenant(2,122);
dc->instantiateTenant(43,194);
dc->instantiateTenant(30,2);
dc->instantiateTenant(100,13);
dc->instantiateTenant(85,46);
dc->instantiateTenant(2,35);
dc->instantiateTenant(206,4);
dc->instantiateTenant(5,23);
dc->instantiateTenant(63,152);
dc->instantiateTenant(4,1);
dc->instantiateTenant(2,25);
dc->instantiateTenant(63,8);
dc->instantiateTenant(64,85);
dc->instantiateTenant(7,28);
dc->instantiateTenant(35,11);
dc->instantiateTenant(3,133);
dc->instantiateTenant(62,151);
dc->instantiateTenant(44,376);
dc->instantiateTenant(104,62);
dc->instantiateTenant(89,28);
dc->instantiateTenant(37,45);
dc->instantiateTenant(2,138);
dc->instantiateTenant(2,418);
dc->instantiateTenant(21,194);
dc->instantiateTenant(21,149);
dc->instantiateTenant(23,63);
dc->instantiateTenant(121,60);
dc->instantiateTenant(78,63);
dc->instantiateTenant(30,55);
dc->instantiateTenant(10,183);
dc->instantiateTenant(16,47);
dc->instantiateTenant(92,95);
dc->instantiateTenant(23,69);
dc->instantiateTenant(83,2);
dc->instantiateTenant(35,13);
dc->instantiateTenant(3,80);
dc->instantiateTenant(107,88);
dc->instantiateTenant(24,143);
dc->instantiateTenant(166,98);
dc->instantiateTenant(34,86);
dc->instantiateTenant(4,10);
dc->instantiateTenant(7,239);
dc->instantiateTenant(2,50);
dc->instantiateTenant(55,29);
dc->instantiateTenant(14,13);
dc->instantiateTenant(62,12);
dc->instantiateTenant(39,178);
dc->instantiateTenant(63,59);
dc->instantiateTenant(177,169);
dc->instantiateTenant(101,91);
dc->instantiateTenant(91,64);
dc->instantiateTenant(8,67);
dc->instantiateTenant(66,248);
dc->instantiateTenant(7,126);
dc->instantiateTenant(18,90);
dc->instantiateTenant(146,7);
dc->instantiateTenant(2,89);
dc->instantiateTenant(147,58);
dc->instantiateTenant(75,20);
dc->instantiateTenant(182,117);
dc->instantiateTenant(5,103);
dc->instantiateTenant(23,174);
dc->instantiateTenant(38,164);
dc->instantiateTenant(56,285);
dc->instantiateTenant(117,19);
dc->instantiateTenant(13,48);
dc->instantiateTenant(12,138);
dc->instantiateTenant(80,337);
dc->instantiateTenant(13,66);
dc->instantiateTenant(98,13);
dc->instantiateTenant(2,140);
dc->instantiateTenant(23,21);
dc->instantiateTenant(2,15);
dc->instantiateTenant(48,29);
dc->instantiateTenant(38,23);
dc->instantiateTenant(114,14);
dc->instantiateTenant(12,91);
dc->instantiateTenant(88,263);
dc->instantiateTenant(43,100);
dc->instantiateTenant(96,56);
dc->instantiateTenant(45,85);
dc->instantiateTenant(124,28);
dc->instantiateTenant(43,77);
dc->instantiateTenant(33,71);
dc->instantiateTenant(26,177);
dc->instantiateTenant(46,230);
dc->instantiateTenant(91,121);
dc->instantiateTenant(38,6);
dc->instantiateTenant(115,57);
dc->instantiateTenant(76,87);
dc->instantiateTenant(199,24);
dc->instantiateTenant(6,21);
dc->instantiateTenant(5,429);
dc->instantiateTenant(8,33);
dc->instantiateTenant(38,12);
dc->instantiateTenant(31,40);
dc->instantiateTenant(195,28);
dc->instantiateTenant(13,178);
dc->instantiateTenant(196,3);
dc->instantiateTenant(51,33);
dc->instantiateTenant(136,3);
dc->instantiateTenant(35,20);
dc->instantiateTenant(32,16);


	//Main tasks that this code does is that iterate for run number of times and after every ping interval which represents 1 sec, dump the data, 

	pthread_t t1,t2;//, t3;
//	pthread_create(&t1, NULL, pingFaults, NULL);

	int flowsNum = dc->all_flows.size();
	end_delay = 1000000 + 5.0;
	struct timespec time1, time2;
	time1.tv_sec = 0;
	time1.tv_nsec = 10; // interval of 100 nano sec, 

	//TODO (ali-mohsin), verify this 100 nsec is the optimal, if not then it can be optimized

	int runs = (runFor);
	int num_fails = failTimes.size(); // would compute to 0

	// cout<<"Number of run: "<<runs<<"\n";
	if(failures)
	{
		for(int i=0; i<runs; i++)
		{
			if (i%100000==0)
				cout<<i<<"th run"<<endl;
			

			dc->autofail(i);
			// seconds_run++;
			// if( (seconds_run % inter_ping_time) == 0 )
			// {
			// 	if( (seconds_run % 31536000) == 0 )
			// 	{
			// 		years_run++;
			// 		seconds_run = seconds_run - 31536000;
			// 	}
			// 	long time_so_far = years_run*31536000 + seconds_run;
			// }

			// if(nanosleep(&time1, &time2) < 0)
			// {
			// 	cout<<"Nanosleep() failed\n";
			// 	return -1;
			// }

			// for(int j=0; j<flowsNum; j++)
			// {
			// 	if( ((dc->all_flows[j]->getActive() + dc->all_flows[j]->getStart()) < run_time ) && (!(dc->all_flows[j]->getDone())))
			// 	{
			// 		dc->all_flows[j]->setDone(true);
			// 		cout<<"Flow has completed!\n";
			// 	}
			// }
		}
	}
	else
	{

		cout<<"You are running simulation with out failures, You are not in Sproj 1 anymore! Please add -failure flag "<<endl;
	}

	finishThis = true;


	int downTime=0;
	int one=0;
	int two=0;
	int three=0;
	int vms;
	for(int i=0;i<dc->all_tenants.size();i++)
	{
		if(dc->all_tenants[i]->level==1)
			one+=dc->all_tenants[i]->downTime;
		if(dc->all_tenants[i]->level==2)
			two+=dc->all_tenants[i]->downTime;
		if(dc->all_tenants[i]->level==3)
			three+=dc->all_tenants[i]->downTime;
		downTime+=dc->all_tenants[i]->downTime;
	}

	cout<<dc->all_tenants.size()<<" was the number of accomodated tenants"<<endl;
	cout<<100-100*(downTime/(float(dc->all_tenants.size())*runs))<<" Was the Availability"<<endl;
	cout<<"Downtime due to level 1: "<<one<<endl;
	cout<<"Downtime due to level 2: "<<two<<endl;
	cout<<"Downtime due to level 3: "<<three<<endl;
		// cout<<100-100*(dc->downTime/(float(dc->all_flows.size())*runs))<<" Was the Availability"<<endl;


	// ********************************** USEFUL CODE ENDS HERE *********************

	return 0;
}

void storeFailure(int pid, int level, int did, float fTime)
{
	failTimes.push_back(fTime);
	failPID.push_back(pid);
	failLevel.push_back(level);
	failDID.push_back(did);
	failed.push_back(false);
	failComplete.push_back(0.0);
}

void * pingFaults(void * args)
{
	struct timespec time1, time2;
	time1.tv_sec = 0;
	time1.tv_nsec = 1000000;	//this is 1 usec == 0.001 msec == 0.000001 sec
	int fault_runs = (fault_delay*1000000000)/time1.tv_nsec;	//calculating num runs to achieve the delay

	while(1)
	{
		// cout<<"here"<<endl;
		for(int i=0; i<fault_runs; i++)
		{
			if(nanosleep(&time1, &time2) < 0)
			{
				cout<<"Nanosleep() failed\n";
				exit(-1);
			}
			if(finishThis)
			{
				pthread_exit(NULL);
			}
		}
		//call the detect fault function

		// while(busy)
		// {
		// 	if(nanosleep(&time1, &time2) < 0)
		// 	{
		// 		cout<<"Nanosleep() failed\n";
		// 		exit(-1);
		// 	}
		// }
		// busy = true;
		run_faults = run_time;
//		cout<<"About to find faults!\n";
		dc->findFaults();
//		cout<<"Done finding faults!\n";
		// busy = false;

		if(finishThis)
		{
			pthread_exit(NULL);
		}
	}

}
